// Handle TargetUnselect packets.

FUNCTION Packet::TargetUnselected 1 _bTargetUnselected

  DEFINE SORTEDLIST TargetUnselected_SL

  CALL_EXTERN "DLIB\Packets\ReadTargetUnselected.l2s" DLIB::Packets::ReadTargetUnselected TargetUnselected_SL 1 _bTargetUnselected

  IF "TargetUnselected_SL.#$SOURCE_OID" == CHAR_ID
    IF "AEGIS.OPTIONS.CONFIG.CONTAINS_KEY HOLD_TARGET" == TRUE
      IF "AEGIS.OPTIONS.CONFIG.#$HOLD_TARGET" == TRUE
        CALL_EXTERN "AEGIS\functions\HoldTarget.l2s" AEGIS::HoldTarget::Process::TargetUnselected VOID 1 TargetUnselected_SL
      ELSE
        LOCK AEGIS.MUTEX.ENTITYTRACKING.CHARACTER
          "AEGIS.ENTITYTRACKING.CHARACTER.CURRENT_TARGET" = ZERO
        UNLOCK AEGIS.MUTEX.ENTITYTRACKING.CHARACTER
      ENDIF
    ELSE
      LOCK AEGIS.MUTEX.ENTITYTRACKING.CHARACTER
        "AEGIS.ENTITYTRACKING.CHARACTER.CURRENT_TARGET" = ZERO
      UNLOCK AEGIS.MUTEX.ENTITYTRACKING.CHARACTER
    ENDIF
    
  ELSE
  
    LOCK AEGIS.MUTEX.ENTITYTRACKING.PLAYERS
     
      IF "AEGIS.ENTITYTRACKING.PLAYERS.CONTAINS_KEY <&TargetUnselected_SL.#$SOURCE_OID&>" == TRUE
        "AEGIS.ENTITYTRACKING.PLAYERS.#$<&TargetUnselected_SL.#$SOURCE_OID&>.CURRENT_TARGET" = ZERO
      ENDIF
      
    UNLOCK AEGIS.MUTEX.ENTITYTRACKING.PLAYERS
    
    LOCK AEGIS.MUTEX.ENTITYTRACKING.NPCS
    
      IF "AEGIS.ENTITYTRACKING.NPCS.CONTAINS_KEY <&TargetUnselected_SL.#$SOURCE_OID&>" == TRUE
        "AEGIS.ENTITYTRACKING.NPCS.#$<&TargetUnselected_SL.#$SOURCE_OID&>.CURRENT_TARGET" = ZERO
      ENDIF
    
    UNLOCK AEGIS.MUTEX.ENTITYTRACKING.NPCS

  ENDIF
  
RETURN VOID